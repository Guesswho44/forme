# =========================
# VLESS WS ROOT "/" + CAMO "/web"
# =========================

# WS upgrade handling (fix utama untuk Sec-WebSocket-Accept)
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# Untuk location "/" : WS -> VLESS (10001), non-WS -> WEB (10015) paksa URI /web
map $http_upgrade $root_backend {
    default 127.0.0.1:10001;  # websocket
    ''      127.0.0.1:10015;  # bukan websocket
}
map $http_upgrade $root_uri {
    default $request_uri;     # websocket, biar URI asal
    ''      /web;             # bukan websocket, paksa /web
}

# =========================
# WS MULTIPLEX (proxy_protocol) - 1010
# =========================
server {
    listen 1010 proxy_protocol so_keepalive=on reuseport;
    server_name xxx;

    set_real_ip_from 127.0.0.1;
    real_ip_header proxy_protocol;

    client_body_buffer_size 200K;
    client_header_buffer_size 4k;
    client_max_body_size 10M;
    large_client_header_buffers 4 8k;
    client_header_timeout 60s;
    keepalive_timeout 75s;

    add_header X-HTTP-LEVEL-HEADER 1 always;
    add_header X-ANOTHER-HTTP-LEVEL-HEADER 1 always;
    add_header X-XSS-Protection "1; mode=block" always;

    # ---------- VMESS WS ----------
    location ^~ /vmess {
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_redirect off;
        proxy_buffering off;
        proxy_request_buffering off;
        proxy_read_timeout 24h;
        proxy_send_timeout 24h;

        proxy_pass http://127.0.0.1:10002;
    }

    # ---------- TROJAN WS ----------
    location ^~ /trojan-ws {
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_redirect off;
        proxy_buffering off;
        proxy_request_buffering off;
        proxy_read_timeout 24h;
        proxy_send_timeout 24h;

        proxy_pass http://127.0.0.1:10003;
    }

    # ---------- SS WS ----------
    location ^~ /ss-ws {
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_redirect off;
        proxy_buffering off;
        proxy_request_buffering off;
        proxy_read_timeout 24h;
        proxy_send_timeout 24h;

        proxy_pass http://127.0.0.1:10004;
    }

    # ---------- CAMO WEB PATH ----------
    location ^~ /web {
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_redirect off;
        proxy_buffering off;
        proxy_request_buffering off;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;

        proxy_pass http://127.0.0.1:10015;
    }

    # ---------- ROOT "/" (WS -> VLESS, NON-WS -> /web) ----------
    location / {
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_redirect off;
        proxy_buffering off;
        proxy_request_buffering off;
        proxy_read_timeout 24h;
        proxy_send_timeout 24h;

        # WS: http://127.0.0.1:10001 + $request_uri
        # Non-WS: http://127.0.0.1:10015 + /web
        proxy_pass http://$root_backend$root_uri;
    }
}

# =========================
# OVPN (proxy_protocol) - 1012
# Kekal macam asal, cuma fix Upgrade compare + IP header
# =========================
server {
    listen 1012 proxy_protocol so_keepalive=on reuseport;
    server_name xxx;

    set_real_ip_from 127.0.0.1;
    real_ip_header proxy_protocol;

    client_body_buffer_size 200K;
    client_header_buffer_size 4k;
    client_max_body_size 10M;
    large_client_header_buffers 4 8k;
    client_header_timeout 60s;
    keepalive_timeout 75s;

    location /fightertunnelovpn {
        # gaya asal: bukan websocket akan “paksa” path camo
        if ($http_upgrade = "") {
            rewrite ^/(.*) /fightertunnelovpn break;
        }

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_redirect off;
        proxy_buffering off;
        proxy_request_buffering off;
        proxy_read_timeout 24h;
        proxy_send_timeout 24h;

        proxy_pass http://127.0.0.1:10012;
    }
}

# =========================
# TLS SITE - 81 (kekal macam asal)
# =========================
server {
    listen 81 ssl http2 reuseport;
    server_name xxx;

    ssl_certificate /etc/xray/xray.crt;
    ssl_certificate_key /etc/xray/xray.key;
    ssl_ciphers EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+ECDSA+AES128:EECDH+aRSA+AES128:RSA+AES128:EECDH+ECDSA+AES256:EECDH+aRSA+AES256:RSA+AES256:EECDH+ECDSA+3DES:EECDH+aRSA+3DES:RSA+3DES:!MD5;
    ssl_protocols TLSv1.2 TLSv1.3;

    root /var/www/html;
}

# =========================
# gRPC (proxy_protocol) - 1013
# =========================
server {
    listen 1013 http2 proxy_protocol so_keepalive=on reuseport;
    server_name xxx;

    set_real_ip_from 127.0.0.1;
    real_ip_header proxy_protocol;

    client_body_buffer_size 200K;
    client_header_buffer_size 4k;
    client_max_body_size 10M;
    large_client_header_buffers 4 8k;
    client_header_timeout 60s;
    keepalive_timeout 75s;

    location ^~ /vless-grpc {
        grpc_set_header Host $host;
        grpc_set_header X-Real-IP $remote_addr;
        grpc_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        grpc_set_header X-Forwarded-Proto $scheme;
        grpc_set_header TE "trailers";

        grpc_read_timeout 24h;
        grpc_send_timeout 24h;

        grpc_pass grpc://127.0.0.1:10005;
    }

    location ^~ /vmess-grpc {
        grpc_set_header Host $host;
        grpc_set_header X-Real-IP $remote_addr;
        grpc_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        grpc_set_header X-Forwarded-Proto $scheme;
        grpc_set_header TE "trailers";

        grpc_read_timeout 24h;
        grpc_send_timeout 24h;

        grpc_pass grpc://127.0.0.1:10006;
    }

    location ^~ /trojan-grpc {
        grpc_set_header Host $host;
        grpc_set_header X-Real-IP $remote_addr;
        grpc_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        grpc_set_header X-Forwarded-Proto $scheme;
        grpc_set_header TE "trailers";

        grpc_read_timeout 24h;
        grpc_send_timeout 24h;

        grpc_pass grpc://127.0.0.1:10007;
    }

    location ^~ /ss-grpc {
        grpc_set_header Host $host;
        grpc_set_header X-Real-IP $remote_addr;
        grpc_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        grpc_set_header X-Forwarded-Proto $scheme;
        grpc_set_header TE "trailers";

        grpc_read_timeout 24h;
        grpc_send_timeout 24h;

        grpc_pass grpc://127.0.0.1:10008;
    }
}
